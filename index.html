<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 TikTok Turbo Stats 🎮 v2</title>
    <style>
        @import url('https://fonts.cdnfonts.com/css/burbank-big-condensed');

        :root {
            --font-primary: 'Burbank Big Condensed', sans-serif;
            --color-bg-gradient-start: #5D3FD3; /* Deeper Purple */
            --color-bg-gradient-end: #1E90FF;   /* Dodger Blue */
            --color-text-light: #ffffff;
            --color-text-secondary: #e0e0e0;
            
            --color-container-bg: rgba(0, 0, 0, 0.3);
            --color-container-border: rgba(255, 255, 255, 0.35);
            --color-container-shadow-main: rgba(255, 105, 180, 0.75); /* Hot Pink Glow */
            --color-container-shadow-main-brighter: rgba(255, 105, 180, 0.95); /* Brighter for animation */
            --color-container-shadow-inset: rgba(0, 255, 255, 0.55); /* Cyan Inner Glow */

            --color-button-gradient-start: #FF1493; /* DeepPink */
            --color-button-gradient-end: #FF69B4;   /* HotPink */
            --color-button-shadow-3d: #b3006e; /* Darker pink for 3D effect */
            --color-button-hover-start: #ff0084;
            --color-button-hover-end: #ff55a8;
            
            --color-stat-bg: rgba(255, 255, 255, 0.12);
            --color-stat-shadow: rgba(0, 255, 255, 0.65); 
            --color-stat-hover-shadow: rgba(255, 0, 255, 0.85);
            
            --color-input-bg: rgba(0, 0, 0, 0.4);
            --color-input-border: rgba(255, 255, 255, 0.4);
            --color-input-focus-border: var(--color-stat-hover-shadow);
            --color-input-focus-shadow: var(--color-stat-hover-shadow);

            --color-update-increase: #39FF14; /* Neon Green */
            --color-update-decrease: #FFD700; /* Gold/Yellow */
            --progress-bar-gradient-start: var(--color-update-decrease);
 --progress-bar-gradient-end: var(--color-update-increase);


            --animation-duration-fast: 0.5s;
            --animation-duration-medium: 0.3s;
        }

        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--color-bg-gradient-start), var(--color-bg-gradient-end));
            color: var(--color-text-light);
            text-align: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 680px; /* Slightly wider */
            width: 95%;
            margin: 20px auto; /* Added top/bottom margin */
            background: var(--color-container-bg);
            padding: 30px 35px; /* Increased padding */
            border-radius: 30px; /* More rounded */
            border: 2px solid var(--color-container-border);
            backdrop-filter: blur(14px);
            animation: subtleGlow 6s infinite alternate ease-in-out;
        }

        @keyframes subtleGlow {
            0% { 
                box-shadow: 0 0 25px var(--color-container-shadow-main),
                            0 0 15px var(--color-container-shadow-inset) inset,
                            0 0 40px rgba(30, 144, 255, 0.5); /* Dodger blue subtle outer glow */
            }
            100% { 
                box-shadow: 0 0 35px var(--color-container-shadow-main-brighter),
                            0 0 25px var(--color-container-shadow-inset) inset,
                            0 0 50px rgba(30, 144, 255, 0.7);
            }
        }

        h2 {
 font-size: 40px; 
            margin-bottom: 35px;
            letter-spacing: 1.5px;
 line-height: 1.2;
            font-weight: 700; /* Bolder font if available */
            text-shadow: 3px 3px 0px #333, /* Darker, more defined shadow */
                         0 0 15px rgba(255,255,255,0.3); /* Soft white aura */
            background: linear-gradient(45deg, var(--color-button-gradient-end), var(--color-text-light), var(--color-button-gradient-start), var(--color-text-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 300% 300%;
            animation: titleGradient 10s infinite ease-in-out alternate;
        }
        @keyframes titleGradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        input[type="text"] {
 width: calc(90% - 32px); 
 padding: 16px; 
            border-radius: 16px; /* More rounded */
            border: 2px solid var(--color-input-border);
            outline: none;
            background: var(--color-input-bg);
            color: var(--color-text-light);
 text-align: center;
            font-size: 18px; 
            font-family: var(--font-primary);
            margin-bottom: 20px; /* Increased margin */
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.6);
            transition: border-color var(--animation-duration-medium), box-shadow var(--animation-duration-medium);
        }
        input[type="text"]::placeholder {
            color: rgba(255,255,255,0.6);
            font-family: var(--font-primary);
        }
        input[type="text"]:focus {
            border-color: var(--color-input-focus-border); 
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5), 0 0 12px var(--color-input-focus-shadow);
        }


        .progress-bar-wrapper {
 margin: 25px auto 20px auto; 
            width: 90%;
        }
        .progress-bar-label {
 font-size: 17px; /* Slightly larger */
            color: var(--color-text-secondary);
            margin-bottom: 10px; /* Increased space */
 text-align: left;
            font-family: var(--font-primary);
            letter-spacing: 0.5px;
            font-weight: bold;
        }
        .progress-bar-container {
            width: 100%;
            height: 14px; /* Thicker bar */
 background-color: rgba(0, 0, 0, 0.5); /* Darker */
            border-radius: 7px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.25); 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4); /* Inner shadow */
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%; 
 background: linear-gradient(90deg, var(--progress-bar-gradient-start), var(--progress-bar-gradient-end)); 
            border-radius: 6px; 
            /* transition set by JS */
            box-shadow: 0 0 8px var(--progress-bar-gradient-end), /* Glow from the fill color */
                        inset 0 -1px 1px rgba(0,0,0,0.25), 
                        inset 0 1px 1px rgba(255,255,255,0.25); 
        }


        a, button {
            display: block;
 margin: 18px auto; /* Increased margin */
            padding: 18px 15px; 
            background: linear-gradient(135deg, var(--color-button-gradient-start), var(--color-button-gradient-end));
            color: var(--color-text-light);
            text-decoration: none;
            border-radius: 16px; 
            font-weight: bold;
            width: 90%;
 text-align: center;
            font-size: 21px; 
            border: none; 
            outline: none;
            cursor: pointer;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.35);
            box-shadow: 0 6px 0 var(--color-button-shadow-3d), 
                        0 9px 20px rgba(var(--color-button-gradient-start), 0.45);
            letter-spacing: 0.5px;
            position: relative; /* For shimmer effect */
            overflow: hidden; /* For shimmer effect */
            transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        box-shadow 0.15s ease, 
                        background 0.2s ease;
        }
        /* Shimmer Effect */
        a::before, button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -150%; /* Start further left */
            width: 70%; /* Wider shimmer */
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
            transform: skewX(-25deg); /* Angled shimmer */
            transition: left 0.7s ease-in-out; /* Slower, smoother transition */
        }
        a:hover::before, button:hover::before {
            left: 150%; /* Move further right */
        }

        a:hover, button:hover {
            transform: scale(1.04) translateY(-4px); 
            box-shadow: 0 8px 0 var(--color-button-shadow-3d), 
                        0 12px 25px rgba(var(--color-button-gradient-start), 0.7);
            background: linear-gradient(135deg, var(--color-button-hover-start), var(--color-button-hover-end));
        }
        a:active, button:active {
            transform: scale(0.97) translateY(2px); 
            box-shadow: 0 3px 0 var(--color-button-shadow-3d),
                        0 6px 15px rgba(var(--color-button-gradient-start), 0.5);
        }


        #statsContainer {
            display: none;
 animation: fadeInStats 0.8s ease-out forwards;
            margin-top: 20px; /* Space above stats */
        }
        @keyframes fadeInStats {
            from { opacity: 0; transform: translateY(25px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        img#cover {
 width: 190px; 
            height: 190px;
            border-radius: 22px; 
            margin-top: 20px;
            margin-bottom: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.75), 0 0 35px rgba(255, 0, 255, 0.55);
 border: 5px solid var(--color-text-light); /* Thicker border */
            transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
            object-fit: cover;
        }
        img#cover:hover {
            transform: scale(1.08) rotate(4deg); 
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.9), 0 0 45px rgba(255, 0, 255, 0.75), 0 0 15px #fff; /* Added white glow */
        }

        .info {
            font-size: 19px; 
 margin: 18px 0;
            color: var(--color-text-secondary);
            line-height: 1.6;
            word-break: break-word;
        }
        .info strong {
            color: var(--color-text-light);
            font-weight: bold; /* Ensure strong is bold */
        }

        .stats {
            display: flex;
 justify-content: space-around;
            margin-top: 30px; /* More space */
            margin-bottom: 20px;
 flex-wrap: wrap;
            gap: 18px; /* Slightly more gap */
        }

        .stats div {
            font-size: 30px; 
            padding: 18px; /* More padding */
            background: var(--color-stat-bg);
 border-radius: 18px; /* More rounded */
            box-shadow: 0 0 14px var(--color-stat-shadow), inset 0 0 8px rgba(0,0,0,0.3); /* Added inset shadow */
            transition: transform 0.28s cubic-bezier(0.175, 0.885, 0.32, 1.275), /* Different bounce */
 box-shadow 0.28s ease-in-out;
            flex-basis: calc(50% - 22px); 
            min-width: 135px; 
            max-width: 170px;
        }

        .stats div:hover {
            transform: scale(1.14) rotate(-2deg); /* Added slight rotation */
            box-shadow: 0 0 25px var(--color-stat-hover-shadow), 
                        0 0 12px rgba(255, 255, 255, 0.35) inset, /* Brighter inset */
                        0 5px 15px rgba(0,0,0,0.2); /* Subtle drop shadow */
        }

        .stats p { 
 font-size: 17px; 
            margin: 9px 0 6px 0;
            font-weight: bold;
 color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.7px; /* More spacing */
        }
        .stats div p:last-of-type { 
            font-size: 32px; 
            font-weight: bold;
            color: var(--color-text-light);
 line-height: 1;
            min-height: 32px; 
            word-break: break-all; 
        }
        
        .stat-value-changing { 
            animation: valueUpdateEffect var(--animation-duration-fast) ease-in-out;
            display: inline-block; 
        }
        @keyframes valueUpdateEffect {
            0%, 100% { transform: scale(1) translateY(0); opacity: 1;}
            30% { transform: scale(1.1) translateY(-3px); opacity: 0.7;}
            60% { transform: scale(1.45) translateY(0px); opacity: 1; color: var(--dynamic-update-color, var(--color-button-gradient-start)); text-shadow: 0 0 12px var(--dynamic-update-color, var(--color-button-gradient-start));}
        }


        /* History Section */
        #historyContainer {
            display: none;
            margin-top: 30px;
            text-align: left;
            animation: fadeInStats 0.8s ease-out forwards;
        }
        #historyContainer h3 {
            font-size: 28px;
            margin-bottom: 20px;
            color: var(--color-text-light);
            text-shadow: 2px 2px 0px #333;
            letter-spacing: 1px;
            font-weight: bold;
        }
        #historyList {
            list-style: none;
            padding: 0;
            max-height: 300px; /* Limit height */
            overflow-y: auto; /* Add scrollbar */
        }
        #historyList li {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 12px;
            font-size: 16px;
            color: var(--color-text-secondary);
            line-height: 1.5;
            word-break: break-word;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        #historyList li strong {
            color: var(--color-text-light);
        }
        #historyList li .timestamp {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            display: block;
            margin-top: 5px;
        }

        /* Chart Section (Placeholder) */
        #chartContainer {
            display: none; /* Initially hidden */
            margin-top: 30px;
            /* Add styling for your chart container */
        }


        /* Responsive adjustments */
        @media (max-width: 700px) {
            .container { padding: 25px 20px; }
            h2 { font-size: 34px; margin-bottom: 30px; }
            .stats div { flex-basis: calc(50% - 15px); }
        }
        @media (max-width: 600px) {
            h2 { font-size: 30px; }
            .stats div {
                min-width: 125px;
                font-size: 26px; 
            }
            .stats p { font-size: 15px; }
            .stats div p:last-of-type { font-size: 28px; }
            img#cover { width: 160px; height: 160px; }
            a, button { font-size: 19px; padding: 15px 12px; }
            input[type="text"] { font-size: 17px; padding: 14px; }
            .info { font-size: 17px; }
            .progress-bar-label {font-size: 15px;}
            .progress-bar-container {height: 12px;}
        }
        @media (max-width: 450px) {
            .container { padding: 20px 15px; }
            h2 { font-size: 26px; letter-spacing: 1px;}
            .stats div {
                flex-basis: 100%; 
                max-width: 280px; /* Allow full width but cap it */
                margin-left: auto;
                margin-right: auto;
            }
            input[type="text"], a, button { width: 95%; }
            .progress-bar-wrapper { width: 95%;}
        }

    </style>
</head>
<body onload="loadHistory()">
    <div class="container">
        <h2>📊 TikTok Turbo Stats 🎮</h2>
        <input type="text" id="videoUrl" placeholder="Paste TikTok Video URL Here!">
        <button id="searchButton" onclick="startFetchingData()">🚀 Get Video Stats!</button>

        <div class="progress-bar-wrapper" id="progressBarWrapper" style="display: none;">
            <p class="progress-bar-label">Next refresh in:</p>
            <div class="progress-bar-container">
                <div id="refreshProgressBar" class="progress-bar-fill"></div>
            </div>
        </div>
        
        <div id="statsContainer">
            <img id="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Video Cover"> <p class="info"><strong>Creator:</strong> <span id="creator">-</span></p>
            <p class="info"><strong>Description:</strong> <span id="desc">-</span></p>
            <p class="info"><strong>Date:</strong> <span id="date">-</span></p>

            <div class="stats">
                <div>👁️ <p>Views</p><p id="views">0</p></div>
                <div>❤️ <p>Likes</p><p id="likes">0</p></div>
                <div>🔄 <p>Shares</p><p id="shares">0</p></div>
                <div>💬 <p>Comments</p><p id="comments">0</p></div>
            </div>

            <p class="info" id="musicInfoSection"><strong>🎵 Music:</strong> <span id="music_title">-</span> by <span id="music_artist">-</span></p>
            <button id="playButton" onclick="playMusic()" style="display: none;">▶️ Play Music</button>
            <a id="downloadMP3" href="#" target="_blank" style="display: none;">🎶 Download MP3</a>
            <a id="download" href="#" target="_blank" style="display: none;">⬇️ Download Video</a>
        </div>

        <!-- History Section -->
        <div id="historyContainer">
            <h3>Update History</h3>
            <ul id="historyList">
                <!-- History items will be added here by JS -->
            </ul>
        </div>
    </div>

    <script>
        let lastStats = { views: 0, likes: 0, shares: 0, comments: 0 };
        let intervalId;
 let musicAudio = null;
 let isTabActive = true; // Flag to track tab visibility
        const API_BASE_URL = 'https://countik.com/api/videoinfo/';
        const ANIMATION_DURATION_MS = 500; 
        const REFRESH_INTERVAL_MS = 20000; // 20 seconds

        function animateCounter(element, target, previous) {
            target = Number(target) || 0;
            previous = Number(previous) || 0;

            if (target !== previous) {
                element.classList.add('stat-value-changing');
                if (target > previous) {
                    element.style.setProperty('--dynamic-update-color', 'var(--color-update-increase)');
                } else {
                    element.style.setProperty('--dynamic-update-color', 'var(--color-update-decrease)');
                }

                setTimeout(() => {
                    element.classList.remove('stat-value-changing');
                    element.style.removeProperty('--dynamic-update-color');
                }, ANIMATION_DURATION_MS);

                let current = previous;
                const steps = 30;
                const durationPerStep = Math.max(15, (ANIMATION_DURATION_MS - 50) / steps);
                const increment = (target - previous) / steps;

                if (element.animationInterval) {
                    clearInterval(element.animationInterval);
                }

                let stepCount = 0;
                element.animationInterval = setInterval(() => {
                    current += increment;
                    stepCount++;

                    if ((increment > 0 && current >= target) || (increment < 0 && current <= target) || stepCount >= steps) {
                        current = target;
                        clearInterval(element.animationInterval);
                        element.animationInterval = null;
                    }
                    element.innerText = Math.round(current).toLocaleString();
                }, durationPerStep);

            } else {
                element.innerText = target.toLocaleString();
            }
        }
        
        // Function to update the progress bar
        function updateProgressBar() {
            const progressBarFill = document.getElementById('refreshProgressBar');
            const progressBarWrapper = document.getElementById('progressBarWrapper');

            if (progressBarFill && progressBarWrapper) {
                progressBarWrapper.style.display = 'block';
                progressBarFill.style.transition = 'none';
                progressBarFill.style.width = '0%';

                // Force reflow to apply the reset width before starting animation
                void progressBarFill.offsetWidth; // Using void for linters

                progressBarFill.style.transition = `width ${REFRESH_INTERVAL_MS / 1000}s linear`;
                progressBarFill.style.width = '100%';
            }
        }

        // Function to fetch video data from the API
        async function fetchVideoData() {
            const urlInput = document.getElementById('videoUrl').value;
            const match = urlInput.match(/video\/(\d+)/);
            if (!match) {
                // Alert is handled by startFetchingData or directly if called without it
                // alert('Invalid TikTok URL. Please paste a valid video link!');
                return false; // Indicate failure
            }
            const videoId = match[1];
            
            const searchButton = document.getElementById('searchButton');
            searchButton.innerText = '⏳ Fetching...';
            searchButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}${videoId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API Error Response: ${errorText}`);
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                // Check for success or if status is missing but data is present
                if (data && data.status !== 'error' && data.creator) {
                  displayData(data);
                  saveHistory(data); // Save history on successful fetch
                  return true; // Indicate success
                } else {
                  throw new Error(data.message || 'Video not found or invalid data from API.');
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                alert(`Could not fetch video data. ${error.message}. Please check the URL or try again later.`);
                document.getElementById('statsContainer').style.display = 'none'; // Hide stats on error
                const progressBarWrapper = document.getElementById('progressBarWrapper');
                if (progressBarWrapper) progressBarWrapper.style.display = 'none'; // Hide progress bar on error
                document.getElementById('historyContainer').style.display = 'none'; // Hide history on error
                return false; // Indicate failure
            } finally {
                 searchButton.innerText = '🚀 Get Video Stats!';
                 searchButton.disabled = false;
            }
        }


        function displayData(data) {
            if (musicAudio && !musicAudio.paused) {
                musicAudio.pause();
                musicAudio.currentTime = 0;
            }
            musicAudio = null;
            document.getElementById('playButton').innerText = '▶️ Play Music';

            document.getElementById('statsContainer').style.display = 'block';
            const progressBarWrapper = document.getElementById('progressBarWrapper');
            if (progressBarWrapper) { // Ensure progress bar is visible when stats are
                progressBarWrapper.style.display = 'block';
                document.getElementById('historyContainer').style.display = 'block'; // Show history when stats are shown
            }

            document.getElementById('creator').innerText = data.creator || 'N/A';
            document.getElementById('desc').innerText = data.desc || 'No description';
            document.getElementById('date').innerText = data.create_date || 'Unknown date';
            document.getElementById('cover').src = data.cover || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

            const downloadLink = document.getElementById('download');
            const downloadMP3Link = document.getElementById('downloadMP3');
            const playButton = document.getElementById('playButton');
            const musicInfoSection = document.getElementById('musicInfoSection');

            if(data.download_link){
                downloadLink.href = data.download_link;
                downloadLink.style.display = 'block';
            } else {
                downloadLink.style.display = 'none';
            }

            if(data.music_play_url && data.music_title) {
                document.getElementById('music_title').innerText = data.music_title || 'Unknown Title';
                document.getElementById('music_artist').innerText = data.music_artist || 'Unknown Artist';
                downloadMP3Link.href = data.music_play_url;
                
                musicInfoSection.style.display = 'block';
                downloadMP3Link.style.display = 'block';
                playButton.style.display = 'block';
            } else {
                musicInfoSection.style.display = 'none';
                downloadMP3Link.style.display = 'none';
                playButton.style.display = 'none';
            }

            animateCounter(document.getElementById('views'), data.plays, lastStats.views);
            animateCounter(document.getElementById('likes'), data.likes, lastStats.likes);
            animateCounter(document.getElementById('shares'), data.shares, lastStats.shares);
            animateCounter(document.getElementById('comments'), data.comments, lastStats.comments);

            lastStats.views = Number(data.plays) || 0;
            lastStats.likes = Number(data.likes) || 0;
            lastStats.shares = Number(data.shares) || 0;
            lastStats.comments = Number(data.comments) || 0;
        }

        // Function to start fetching data and set up the interval
        function startFetchingData() {
            const urlInput = document.getElementById('videoUrl').value;
            if (!urlInput.match(/video\/(\d+)/)) {
                alert('Invalid TikTok URL. Please paste a valid video link!');
                return;
            }

            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null; // Explicitly nullify
            }

            fetchVideoData().then(success => {
                if (success && document.getElementById('statsContainer').style.display === 'block') {
                    updateProgressBar(); 
                    // Clear any existing interval before setting a new one
                    if (intervalId) clearInterval(intervalId);

                    intervalId = setInterval(() => {
                        if (isTabActive) { // Only fetch if the tab is active
                            fetchVideoData().then(fetchSuccess => {
                                if (fetchSuccess && intervalId) {
                                    updateProgressBar();
                                } else if (!fetchSuccess) {
                                    updateProgressBar(); // Or hide it
                                }
                            });
                        }
                    }, REFRESH_INTERVAL_MS); // Set interval to check and fetch
                } else if (!success) {
                    const progressBarWrapper = document.getElementById('progressBarWrapper');
                    if (progressBarWrapper) progressBarWrapper.style.display = 'none';
                    if (intervalId) { // If initial fetch failed but interval was somehow set, clear it
                         clearInterval(intervalId);
                         intervalId = null;
                    }
                }
            });
        }

        // Function to stop fetching data and clear the interval
        function stopFetchingData() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            const progressBarWrapper = document.getElementById('progressBarWrapper');
            const progressBarFill = document.getElementById('refreshProgressBar');
            if (progressBarWrapper) progressBarWrapper.style.display = 'none';
            if (progressBarFill) {
                progressBarFill.style.transition = 'none';
                progressBarFill.style.width = '0%';
            }
        }

        // Function to play or stop music
        function playMusic() {
            const musicUrl = document.getElementById('downloadMP3').href;
            const playButton = document.getElementById('playButton');

            if (!musicUrl || musicUrl === window.location.href + '#') {
                alert("No music URL available for this video.");
                return;
            }

            if (musicAudio && !musicAudio.paused) {
                musicAudio.pause();
                playButton.innerText = "▶️ Play Music";
            } else {
                if (!musicAudio || musicAudio.src !== musicUrl) {
                    musicAudio = new Audio(musicUrl);
                    musicAudio.onended = function() { // Moved onended here
                        playButton.innerText = "▶️ Play Music";
                        if(musicAudio) musicAudio.currentTime = 0;
                    };
                }
                musicAudio.play().then(() => { // Use promise-based play for better error handling
                    playButton.innerText = "⏹️ Stop Music";
                }).catch(error => {
                    console.error("Error playing music:", error);
                    alert("Could not play music. The audio format might not be supported or the link is broken.");
                    playButton.innerText = "▶️ Play Music"; 
                });
            }
        }

        // --- History Functions ---
        function saveHistory(newData) {
            const historyList = document.getElementById('historyList');
            const currentUrl = document.getElementById('videoUrl').value;
            const historyKey = `tiktokStatsHistory_${currentUrl}`;
            let history = JSON.parse(localStorage.getItem(historyKey)) || [];

            const now = new Date();
            const timestamp = now.toISOString();

            let changes = [];
            const previousData = history.length > 0 ? history[history.length - 1].data : null;

            // Check for changes
            if (previousData) {
                if (newData.plays !== previousData.plays) {
                    changes.push(`Views changed from ${previousData.plays.toLocaleString()} to ${newData.plays.toLocaleString()}`);
                }
                if (newData.likes !== previousData.likes) {
                    changes.push(`Likes changed from ${previousData.likes.toLocaleString()} to ${newData.likes.toLocaleString()}`);
                }
                if (newData.shares !== previousData.shares) {
                    changes.push(`Shares changed from ${previousData.shares.toLocaleString()} to ${newData.shares.toLocaleString()}`);
                }
                if (newData.comments !== previousData.comments) {
                    changes.push(`Comments changed from ${previousData.comments.toLocaleString()} to ${newData.comments.toLocaleString()}`);
                }
                if (newData.desc !== previousData.desc) {
                    changes.push(`Description updated.`);
                }
                if (newData.music_title !== previousData.music_title || newData.music_artist !== previousData.music_artist) {
                     changes.push(`Music info updated.`);
                }
                // Add more checks for other fields if needed
            } else {
                // First entry for this video
                changes.push(`Initial data recorded.`);
            }

            // Only add history entry if there are changes or it's the first entry
            if (changes.length > 0) {
                const historyEntry = {
                    timestamp: timestamp,
                    data: { // Store relevant data
                        plays: newData.plays,
                        likes: newData.likes,
                        shares: newData.shares,
                        comments: newData.comments,
                        desc: newData.desc,
                        music_title: newData.music_title,
                        music_artist: newData.music_artist,
                        // Add other fields you want to track
                    },
                    changes: changes // Store the list of changes
                };

                history.push(historyEntry);
                localStorage.setItem(historyKey, JSON.stringify(history));
                displayHistoryEntry(historyEntry); // Add the new entry to the displayed list
            }
        }

        function loadHistory() {
            const historyList = document.getElementById('historyList');
            const currentUrl = document.getElementById('videoUrl').value; // This will be empty on load
            // History is loaded when a video URL is successfully fetched and displayed
            // The saveHistory function handles displaying the history for the current video
        }

        function displayHistoryEntry(entry) {
            const historyList = document.getElementById('historyList');
            const listItem = document.createElement('li');

            const timeAgo = timeSince(new Date(entry.timestamp));
            listItem.innerHTML = `<strong>${timeAgo} ago:</strong> ${entry.changes.join(', ')}<span class="timestamp">${new Date(entry.timestamp).toLocaleString()}</span>`;
            historyList.prepend(listItem); // Add to the top
        }

        // Helper function to format time ago
        function timeSince(date) {
            // Basic implementation - can be expanded for more detail
            const seconds = Math.floor((new Date() - new Date(date)) / 1000); // Ensure date is treated as Date object
            if (seconds < 60) return `${seconds} second${seconds === 1 ? '' : 's'}`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes === 1 ? '' : 's'}`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'}`;
            const days = Math.floor(hours / 24);
            return `${days} day${days === 1 ? '' : 's'}`;
        }

        // --- Visibility Change Handling ---
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                // Tab is inactive
                isTabActive = false;
                // Optionally pause music if playing
                if (musicAudio && !musicAudio.paused) {
                    musicAudio.pause();
                }
            } else {
                // Tab is active
                isTabActive = true;
                // The interval will automatically resume fetching on the next tick if it's running
            }
        });
    </script>
</body>
</html>
